# 付費聯絡系統 - 實作完成

## ✅ 已完成的功能

### 1. 後端服務層 (Services)

#### TokenService (`src/services/token.service.ts`)
- ✅ 查詢代幣餘額
- ✅ 創建代幣帳戶（新用戶贈送 1000 代幣）
- ✅ 扣除代幣（付費功能）
- ✅ 增加代幣（退款機制）
- ✅ 交易記錄查詢
- ✅ 餘額檢查

#### ConversationService (`src/services/conversation.service.ts`)
- ✅ 創建直接聯絡對話（200 代幣）
- ✅ 創建提案對話（工程師付 100 代幣）
- ✅ 發案者解鎖提案（付 100 代幣）
- ✅ 發送訊息（含權限檢查）
- ✅ 取得對話列表
- ✅ 取得訊息列表
- ✅ 標記已讀
- ✅ 未讀訊息計數

#### BidService 整合 (`src/services/bid.service.ts`)
- ✅ 提交投標時自動創建提案對話
- ✅ 自動扣除 100 代幣
- ✅ 發送初始提案訊息

---

### 2. API 端點

#### 代幣相關
- ✅ `GET /api/v1/tokens/balance` - 查詢餘額
- ✅ `GET /api/v1/tokens/transactions` - 查詢交易記錄

#### 對話相關
- ✅ `GET /api/v1/conversations` - 對話列表
- ✅ `GET /api/v1/conversations/:id` - 對話詳情
- ✅ `GET /api/v1/conversations/:id/messages` - 訊息列表
- ✅ `POST /api/v1/conversations/:id/messages` - 發送訊息
- ✅ `POST /api/v1/conversations/direct` - 創建直接聯絡（200 代幣）
- ✅ `POST /api/v1/conversations/unlock-proposal` - 解鎖提案（100 代幣）

---

### 3. 前端組件與頁面

#### 工具函式
- ✅ `src/utils/contactDetection.ts` - 聯絡方式檢測
  - Email、電話、社群媒體、網址等檢測
  - 支援即時驗證與移除
- ✅ `src/utils/paymentConfirm.ts` - 模擬付費確認
  - 統一的付費確認對話框
  - 預設付費選項模板

#### 提案功能
- ✅ `src/components/projects/ProposalForm.tsx` - 提案表單
  - Markdown 編輯與預覽
  - 即時聯絡方式檢測與警告
  - 預算與時程輸入
  - 100 代幣付費確認
  - 提交後自動導向聊天室
- ✅ `src/components/projects/ProjectDetailClient.tsx` - 專案詳情客戶端組件
  - 整合提案按鈕
  - 條件式渲染（登入/非登入/業主）

#### 聊天功能
- ✅ `src/app/conversations/page.tsx` - 聊天室列表
  - 直接聯絡 vs 提案聯絡標籤
  - 已解鎖/待解鎖狀態顯示
  - 最後訊息預覽
  - 時間排序
- ✅ `src/app/conversations/[id]/page.tsx` - 聊天室對話頁面
  - Markdown 渲染（提案內容）
  - 解鎖提案按鈕（發案者）
  - 聯絡資訊顯示（已解鎖）
  - 訊息發送限制（工程師等待解鎖）
  - 即時訊息顯示
  - 自動滾動

#### 使用者功能
- ✅ `src/app/users/[id]/page.tsx` - 使用者個人頁面
  - 解鎖聯絡方式按鈕（200 代幣）
  - 非本人才顯示
  - 登入檢查

---

### 4. 資料庫設計

#### 已創建的表與 ENUM
- ✅ `conversation_type` ENUM
- ✅ `transaction_type` ENUM
- ✅ `user_tokens` 表
- ✅ `token_transactions` 表
- ✅ `conversations` 表（重構）
- ✅ `messages` 表（更新）

#### RLS 政策
- ✅ `users` 表 - 自己或公開資訊
- ✅ `user_tokens` 表 - 僅自己
- ✅ `token_transactions` 表 - 僅自己
- ✅ `conversations` 表 - 參與者
- ✅ `messages` 表 - 對話參與者

---

## 🎯 功能流程說明

### A. 提案流程（工程師端）

1. **瀏覽專案** → 點擊「提交提案」
2. **填寫提案表單**
   - 輸入預算、時程
   - 撰寫提案內容（支援 Markdown）
   - 系統即時檢測聯絡方式
3. **提交確認**
   - 彈出確認對話框：「確認支付 100 代幣？」
   - 提示：7日無回應將退回代幣
4. **自動處理**
   - 創建 bid 記錄
   - 扣除 100 代幣
   - 創建提案對話
   - 發送初始提案訊息
5. **導向聊天室** → 等待發案者回應

### B. 查看提案流程（發案者端）

1. **收到提案通知** → 進入專案投標列表
2. **查看投標摘要**
   - 顯示工程師名稱、預算、時程
   - 顯示「🔒 查看提案 (100 代幣)」按鈕
3. **點擊解鎖**
   - 彈出確認對話框：「確認支付 100 代幣？」
4. **自動處理**
   - 扣除 100 代幣
   - 對話狀態更新為 `is_unlocked: true`
5. **進入聊天室**
   - 查看完整 Markdown 提案
   - 查看工程師聯絡資訊
   - 開始雙向對話

### C. 直接聯絡流程

1. **瀏覽使用者個人頁面**
2. **點擊「解鎖聯絡方式」**
   - 彈出確認對話框：「確認支付 200 代幣？」
3. **自動處理**
   - 扣除 200 代幣
   - 創建直接聯絡對話
   - 對話立即解鎖
4. **進入聊天室**
   - 查看對方聯絡資訊
   - 開始雙向對話

---

## 📋 測試檢查清單

### 提案功能
- [ ] 提案表單正常顯示
- [ ] Markdown 編輯與預覽功能正常
- [ ] 聯絡方式檢測（Email、電話、Line 等）
- [ ] 包含聯絡方式時無法提交
- [ ] 提交後正確扣除 100 代幣
- [ ] 創建對話並發送初始訊息
- [ ] 導向聊天室

### 查看提案功能
- [ ] 發案者可看到提案列表
- [ ] 顯示解鎖按鈕與代幣數
- [ ] 點擊後正確扣除 100 代幣
- [ ] 對話狀態更新為已解鎖
- [ ] 可查看完整提案內容（Markdown 渲染）
- [ ] 可查看工程師聯絡資訊
- [ ] 可雙向對話

### 直接聯絡功能
- [ ] 使用者個人頁面顯示聯絡按鈕
- [ ] 本人頁面不顯示聯絡按鈕
- [ ] 未登入顯示登入提示
- [ ] 點擊後正確扣除 200 代幣
- [ ] 創建對話並立即解鎖
- [ ] 可查看對方聯絡資訊
- [ ] 可雙向對話

### 聊天功能
- [ ] 聊天室列表正確顯示所有對話
- [ ] 區分直接聯絡 vs 提案聯絡
- [ ] 顯示已解鎖/待解鎖狀態
- [ ] 點擊進入對話頁面
- [ ] 訊息正常發送與接收
- [ ] Markdown 內容正確渲染
- [ ] 工程師在發案者解鎖前只能發送一次
- [ ] 已解鎖後可雙向對話
- [ ] 聯絡資訊正確顯示

### 代幣功能
- [ ] 新用戶創建時獲得 1000 代幣
- [ ] 餘額查詢正常
- [ ] 扣款正常
- [ ] 交易記錄正確
- [ ] 餘額不足時無法付費

---

## 🐛 已知限制

### 1. 即時更新
- ❌ 訊息列表不會即時更新，需手動刷新
- **建議**：後續整合 Supabase Realtime 或 WebSocket

### 2. 7日退款機制
- ❌ 尚未實作自動退款 cron job
- **建議**：使用 Supabase Edge Functions 或 Vercel Cron Jobs

### 3. 檔案上傳
- ❌ 訊息僅支援文字
- **建議**：整合 Supabase Storage

### 4. 通知系統
- ❌ 尚未實作即時通知
- **建議**：整合推送通知或 Email 通知

---

## 🚀 使用方式

### 1. 執行資料庫遷移

```bash
# 在 Supabase SQL Editor 中執行
supabase_migration_payment_contact.sql
```

### 2. 驗證 RLS 政策

在 Supabase Dashboard → Authentication → Policies 中確認所有政策已啟用。

### 3. 測試流程

1. 創建兩個測試帳號（工程師、發案者）
2. 發案者發布專案
3. 工程師提交提案（測試 100 代幣扣款）
4. 發案者解鎖提案（測試 100 代幣扣款）
5. 雙方在聊天室對話
6. 測試直接聯絡（測試 200 代幣扣款）

---

## 📦 已安裝的套件

```bash
react-markdown
remark-gfm
rehype-sanitize
```

---

## 🎉 總結

所有核心功能已完整實作：

1. ✅ 代幣系統
2. ✅ 提案流程（工程師付費 100）
3. ✅ 查看提案流程（發案者付費 100）
4. ✅ 直接聯絡流程（付費 200）
5. ✅ 聊天室系統
6. ✅ Markdown 支援
7. ✅ 聯絡方式檢測
8. ✅ 模擬付費確認

系統已可正常運作，後續可根據實際使用情況優化與擴展功能！

